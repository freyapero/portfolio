# API аутентификации по 4 цифрам

Аутентификация пользователей по 4 цифрам номера поступившего звонка используется в приложении «Максим» и в сервисах сторонних организаций.

Это реализовано через Taxsee phone-auth API, который использует механизм OTP (One Time Password) — системы для входа в сервис с использованием уникального одноразового пароля, который невозможно использовать повторно. Его действие может быть ограничено определённым промежутком времени.


### Взаимодействие с сервисом maxim auth
1. Пользователь вводит номер телефона и запрашивает звонок;
2. Номер телефона поступает в сервис-клиент;
3. Сервис-клиент через Taxsee phone-auth API отправляет запрос в сервис maxim auth;
4. Сервис maxim auth возвращает в параметре code сервис-клиенту 4 цифры номера, с которого будет происходить звонок пользователю;
5. Сервис maxim auth ставит исходящий звонок в очередь, а затем происходит звонок пользователю;
6. Пользователь вводит 4 последние цифры входящего звонка в форму сервис-клиента;
7. В сервис-клиенте происходит проверка соответствия введенных цифр и кода, полученного от сервиса maxim auth;
8. От сервиса-клиента устройство пользователя получает токен аутентификации, а пользователь получает доступ в личный кабинет.

![Схема взаимодействия с auth-сервисом](resources/shema_maxim_auth.png)

### Taxsee phone-auth API: создание кода проверки идентификации
POST /calls/{phone}

Для аутентификации используется схема bearerAuth для токена пользователя.

По токену также определяются настройки подразделения и типа.

**cURL**

    curl 'https://api.taxsee.com/phone-auth/v1/calls/77770001122' \
      -X 'POST' \
     -H 'accept: application/json' \
     -H "Authorization: Bearer {token}" \

**Request URL | Production RU**

    https://api.taxsee.com/phone-auth/v1/calls/{phone}

**Request URL | Production Test**

    https://test-api.taxsee.com/phone-auth/v1/calls/{phone}

**Request URL | Development**

    https://dev-api.taxsee.com/phone-auth/v1/calls/{phone}

**Request URL | Example**

    https://api.taxsee.com/phone-auth/v1/calls/77770001122
Происходит создание кода проверки идентификации после чего приходит ответ.

Если запрос обработан успешно, API вернет HTTP-код 200 и четырехзначный код для проверки аутентификации по OTP в параметре "code" ответа:

**Response| Example**

    {  "success": true,  "code": "3210"}
Если в процессе обработки произойдет ошибка, API вернет HTTP-код ошибки и информацию об ошибке в следующей структуре:

**Response**

    {  "success": false,  "error": {    "name": "string",    "message": "string",    "code": 0,    "status": 0  }}

#### Коды ошибок

| Код ответа  |Название | Описание |
| ------------- | ------------- |------------- |
| 400 |Bad Request |Ошибка в синтаксисе запроса, например, не передан номер телефона  |
| 403  |Forbidden|  Действие запрещено для данного пользователя  |
| 422  |Unprocessable Entity|  Ошибка в переданных данных, например, номер телефона содержит ошибки  |
| 429 |Too Many Requests| Слишком много запросов, подробности ограничений в заголовках ответа X-Rate-Limit-*  |
| 500  |Internal Server Error | Внутренняя ошибка сервера  |

### Аутентификация по OTP на сайте ресторана «Япоки»
На сайте ресторана «Япоки» используется система аутентификации по OTP через Taxsee phone-auth API.

Пользователь вводит свой номер телефона в форме сервиса-клиента.

![Япоки_ввод_телефона](resources/yapoki_1.png)

В сервис-клиент уходит код аутентификации и пользователь получает звонок с номера, последние 4 цифры которого выступают кодом аутентификации. Последние 4 цифры номера прозвона и код в сервисе-клиенте совпадают.

![Япоки_прозвон](resources/yapoki_2.png)

Пользователь вводит цифры из номера прозвона в форму сервиса-клиента. В примере это цифры «0451».

![Япоки_прозвон](resources/yapoki_3.png)

Если цифры введены верно, пользователь попадет в личный кабинет.

Если цифры введены неверно, пользователь получит сообщение «Неверный код» в форме аутентификации сервиса-клиента.

Если пользователь попробует сделать повторный запрос на получение кода в интервал менее минуты, то получит сообщение «Звонок-сброс уже совершен» в форме аутентификации сервиса-клиента.
